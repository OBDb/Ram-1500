name: Response tests

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout schemas repo
        uses: actions/checkout@v4
        with:
          repository: OBDb/.schemas
          path: tests/schemas

      - name: Run tests and format failures in devcontainer
        id: test
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/obdb/devcontainer
          push: never
          runCmd: |
            set +e
            pytest tests/ --ignore=tests/schemas -xvs -n auto > ./test-output.txt 2>&1
            TEST_EXIT=$?
            cat ./test-output.txt

            # Format failures for PR comment
            /usr/local/bin/format-test-failures.sh test-output.txt > ./test-failures.md

            exit $TEST_EXIT

      - name: Set test failures output
        if: failure()
        run: |
          if [ -f test-failures.md ]; then
            {
              echo 'TEST_FAILURES<<EOFMARKER'
              cat test-failures.md
              echo 'EOFMARKER'
            } >> $GITHUB_ENV
          fi

      - name: Comment test failures on PR
        if: failure() && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: ${{ env.TEST_FAILURES }}
          comment_tag: response-tests
