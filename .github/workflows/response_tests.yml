name: Response tests

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout schemas repo
        uses: actions/checkout@v4
        with:
          repository: OBDb/.schemas
          path: tests/schemas

      - name: Run tests in devcontainer
        id: test
        uses: devcontainers/ci@v0.3
        continue-on-error: true
        with:
          imageName: ghcr.io/obdb/devcontainer
          runCmd: |
            pytest tests/ --ignore=tests/schemas -xvs -n auto > /tmp/test-output.txt 2>&1
            echo $? > /tmp/exit-code.txt
            cat /tmp/test-output.txt
            exit $(cat /tmp/exit-code.txt)

      - name: Check test results
        id: check-result
        if: always()
        run: |
          if [ "${{ steps.test.outcome }}" = "failure" ]; then
            echo "tests_failed=true" >> $GITHUB_OUTPUT
          else
            echo "tests_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with test results
        if: steps.check-result.outputs.tests_failed == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `## ‚ùå Response Tests Failed

            ### How to fix
            To update the test expectations based on the current signalset values, run:
            \`\`\`bash
            python3 tests/update_yaml_tests.py --verbose
            \`\`\`

            See the [Actions run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for full test output.`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if tests failed
        if: steps.check-result.outputs.tests_failed == 'true'
        run: |
          echo "::error title=Tests Failed::To fix the failed tests, run: python3 tests/update_yaml_tests.py --verbose"
          exit 1