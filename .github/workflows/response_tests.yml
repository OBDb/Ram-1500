name: Response tests

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout schemas repo
        uses: actions/checkout@v4
        with:
          repository: OBDb/.schemas
          path: tests/schemas

      - name: Run tests in devcontainer
        id: test
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/obdb/devcontainer
          push: never
          runCmd: |
            set +e
            pytest tests/ --ignore=tests/schemas -xvs -n auto > ./test-output.txt 2>&1
            TEST_EXIT=$?
            cat ./test-output.txt
            exit $TEST_EXIT

      - name: Extract and format failure details
        if: failure()
        id: extract-failures
        run: |
          if [ -f test-output.txt ]; then
            # Extract the assertion error message which has the key info
            FAILURES=$(grep -A 2 "AssertionError: Signal" test-output.txt || echo "")

            if [ -n "$FAILURES" ]; then
              # Process each failure line to extract: signal, file, line, got, expected
              FORMATTED=""
              while IFS= read -r line; do
                if [[ $line =~ Signal\ ([^\ ]+)\ value\ mismatch\ \(defined\ in\ ([^:]+):([^)]+)\):\ got\ ([^,]+),\ expected\ (.+) ]]; then
                  SIGNAL="${BASH_REMATCH[1]}"
                  FILE="${BASH_REMATCH[2]}"
                  LINE="${BASH_REMATCH[3]}"
                  GOT="${BASH_REMATCH[4]}"
                  EXPECTED="${BASH_REMATCH[5]}"

                  # Extract just the filename and model year
                  FILENAME=$(basename "$FILE")
                  YEAR=$(echo "$FILE" | grep -oP '\d{4}(?=/commands)')

                  FORMATTED+="### Model year: ${YEAR}\n\n"
                  FORMATTED+="Command failed: [\`${FILENAME}:${LINE}\`](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/blob/${GITHUB_SHA}/tests/test_cases/${YEAR}/commands/${FILENAME}#L${LINE})\n\n"
                  FORMATTED+="\`\`\`\nSignal ${SIGNAL} value mismatch: got ${GOT}, expected ${EXPECTED}\n\`\`\`\n\n"
                fi
              done <<< "$FAILURES"

              if [ -z "$FORMATTED" ]; then
                # Fallback if regex didn't match
                FORMATTED="$FAILURES"
              fi
            else
              # Get last 100 lines as fallback
              FORMATTED=$(tail -100 test-output.txt)
            fi

            {
              echo "failures<<ENDOFFAILURES"
              echo -e "$FORMATTED"
              echo "ENDOFFAILURES"
            } >> $GITHUB_OUTPUT
          else
            echo "failures=Could not retrieve test output" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with test failures
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const failures = `${{ steps.extract-failures.outputs.failures }}`;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = `## ‚ùå Response Tests Failed

            ${failures}

            [View full test output](${runUrl})

            ### How to fix
            To update the test expectations based on the current signalset values, run:
            \`\`\`bash
            python3 tests/update_yaml_tests.py --verbose
            \`\`\``;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });