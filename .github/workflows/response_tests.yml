name: Response tests

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout schemas repo
        uses: actions/checkout@v4
        with:
          repository: OBDb/.schemas
          path: tests/schemas

      - name: Run tests in devcontainer
        id: test
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/obdb/devcontainer
          push: never
          runCmd: |
            set +e
            pytest tests/ --ignore=tests/schemas -xvs -n auto > ./test-output.txt 2>&1
            TEST_EXIT=$?
            cat ./test-output.txt
            exit $TEST_EXIT

      - name: Extract and format failure details
        if: failure()
        run: |
          if [ -f test-output.txt ]; then
            # Extract assertion errors
            FAILURES=$(grep "AssertionError: Signal" test-output.txt || echo "")

            {
              echo 'TEST_FAILURES<<EOFMARKER'
              echo '## âŒ Response Tests Failed'
              echo ''

              if [ -n "$FAILURES" ]; then
                # Parse each failure line using sed
                echo "$FAILURES" | while read -r line; do
                  # Extract: Signal NAME value mismatch (defined in PATH:LINE): got VALUE1, expected VALUE2
                  SIGNAL=$(echo "$line" | sed -n 's/.*Signal \([^ ]*\) value mismatch.*/\1/p')
                  FILE=$(echo "$line" | sed -n 's/.*defined in \([^:]*\):.*/\1/p')
                  LINE=$(echo "$line" | sed -n 's/.*defined in [^:]*:\([^)]*\)).*/\1/p')
                  GOT=$(echo "$line" | sed -n 's/.*got \([^,]*\),.*/\1/p')
                  EXPECTED=$(echo "$line" | sed -n 's/.*expected \(.*\)/\1/p')

                  if [ -n "$SIGNAL" ] && [ -n "$FILE" ]; then
                    FILENAME=$(basename "$FILE")
                    YEAR=$(echo "$FILE" | grep -oE '[0-9]{4}' | head -1)

                    echo "### Model year: ${YEAR}"
                    echo ""
                    echo "Command failed: [\`${FILENAME}:${LINE}\`](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/blob/${GITHUB_SHA}/tests/test_cases/${YEAR}/commands/${FILENAME}#L${LINE})"
                    echo ""
                    echo '```'
                    echo "Signal ${SIGNAL} value mismatch: got ${GOT}, expected ${EXPECTED}"
                    echo '```'
                    echo ""
                  fi
                done
              else
                # Fallback
                echo '```'
                tail -100 test-output.txt
                echo '```'
              fi

              echo ""
              echo "[View full test output](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})"
              echo ""
              echo "### How to fix"
              echo "To update the test expectations based on the current signalset values, run:"
              echo '```bash'
              echo "python3 tests/update_yaml_tests.py --verbose"
              echo '```'
              echo 'EOFMARKER'
            } >> $GITHUB_ENV
          fi

      - name: Comment test failures on PR
        if: failure() && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: ${{ env.TEST_FAILURES }}
          comment_tag: response-tests
