name: Response tests

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout schemas repo
        uses: actions/checkout@v4
        with:
          repository: OBDb/.schemas
          path: tests/schemas

      - name: Run tests in devcontainer
        id: test
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/obdb/devcontainer
          push: never
          runCmd: |
            pytest tests/ --ignore=tests/schemas -xvs -n auto > ./test-output.txt 2>&1
            TEST_EXIT=$?
            cat ./test-output.txt

            # Format results for PR comment (always succeeds)
            /usr/local/bin/format-test-results.sh test-output.txt $TEST_EXIT > ./test-results.md || true

            # Exit with the actual test result
            exit $TEST_EXIT

      - name: Set test results output
        if: always() && github.event_name == 'pull_request'
        run: |
          if [ -f test-results.md ]; then
            {
              echo 'TEST_RESULTS<<EOFMARKER'
              cat test-results.md
              echo 'EOFMARKER'
            } >> $GITHUB_ENV
          fi

      - name: Comment test results on PR
        if: always() && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: ${{ env.TEST_RESULTS }}
          comment_tag: response-tests
